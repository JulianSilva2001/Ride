generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("USER") // USER, HOST, ADMIN
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Personal Info (MVP)
  dob           DateTime?
  address       String?
  city          String?
  phone         String?
  
  // Agreements
  termsAccepted Boolean   @default(false)

  kyc           KYC?

  cars          Car[]
  bookings      Booking[]
  reviews       Review[]
}

model KYC {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Contact
  // phone moved to User model

  // NIC Verification
  nic           String?
  nicFront      String?
  nicBack       String?
  selfie        String?

  // Driver Verification
  driverLicense String?
  licenseFront  String?
  licenseExpiry DateTime?

  // Financials
  bankName      String?
  branch        String?
  accountName   String?
  accountNumber String?
  accountType   String?  // Savings, Current
  
  // Consent
  vehicleOwnershipConfirmed Boolean @default(false)

  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  uploadedAt    DateTime @default(now())
}

model Car {
  id          String   @id @default(cuid())
  make        String?
  model       String?
  year        Int?
  pricePerDay Float?
  currency    String   @default("LKR")
  description String?
  category    String   @default("Car")

  images      Image[]  
  location    String?
  features    String?   // Comma-separated string

  hostId      String
  host        User     @relation(fields: [hostId], references: [id], onDelete: Cascade)

  bookings    Booking[]
  reviews     Review[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Step 1: Basics
  transmission String?
  fuelType     String?
  engineSize   String?
  trim         String?
  
  // Step 2: Location & Availability
  availabilityType String?
  deliveryOption   Boolean @default(false)
  deliveryFee      Float?

  // Step 3: Pricing & Rules
  securityDeposit Float?
  includedKm      Int?
  extraKmFee      Float?
  fuelPolicy      String?
  
  // Step 4: Details & Rules
  rules           String?
  
  // Step 6: Protection & GPS
  protectionTier  String?
  gpsInstalled    Boolean @default(false)

  // Step 7: Legal
  regNumber       String?
  insuranceExpiry DateTime?
  ownershipConfirmed Boolean @default(false)
  
  // Documents
  registrationBookUrl String?
  insuranceCertUrl    String?
  emissionCertUrl     String?
  emissionExpiry      DateTime?

  // State
  status          String   @default("DRAFT")
}

model Image {
  id        String   @id @default(cuid())
  url       String
  label     String?
  carId     String
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)
}

model Booking {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  totalCost Float
  status    String   @default("PENDING")

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  carId     String
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  carId     String
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}
